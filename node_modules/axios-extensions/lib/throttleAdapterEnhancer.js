'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

exports.default = throttleAdapterEnhancer;

var _lruCache = require('lru-cache');

var _lruCache2 = _interopRequireDefault(_lruCache);

var _buildSortedURL = require('./utils/buildSortedURL');

var _buildSortedURL2 = _interopRequireDefault(_buildSortedURL);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @author Kuitos
 * @homepage https://github.com/kuitos/
 * @since 2017-10-11
 */

function throttleAdapterEnhancer(adapter) {
	var _this = this;

	var threshold = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1000;
	var cacheCapacity = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 10;


	var cache = new _lruCache2.default({ max: cacheCapacity });
	var recordCacheWithRequest = function recordCacheWithRequest(index, config) {

		var responsePromise = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
			var response;
			return _regenerator2.default.wrap(function _callee$(_context) {
				while (1) {
					switch (_context.prev = _context.next) {
						case 0:
							_context.prev = 0;
							_context.next = 3;
							return adapter(config);

						case 3:
							response = _context.sent;


							cache.set(index, {
								timestamp: Date.now(),
								value: Promise.resolve(response)
							});

							return _context.abrupt('return', response);

						case 8:
							_context.prev = 8;
							_context.t0 = _context['catch'](0);

							cache.del(index);
							return _context.abrupt('return', Promise.reject(_context.t0));

						case 12:
						case 'end':
							return _context.stop();
					}
				}
			}, _callee, _this, [[0, 8]]);
		}))();

		cache.set(index, {
			timestamp: Date.now(),
			value: responsePromise
		});

		return responsePromise;
	};

	return function (config) {
		var url = config.url,
		    method = config.method,
		    params = config.params,
		    paramsSerializer = config.paramsSerializer;

		var index = (0, _buildSortedURL2.default)(url, params, paramsSerializer);

		var now = Date.now();
		var cachedRecord = cache.get(index) || { timestamp: now };

		if (method === 'get') {

			if (now - cachedRecord.timestamp <= threshold) {

				var responsePromise = cachedRecord.value;
				if (responsePromise) {

					/* istanbul ignore next */
					if (process.env.LOGGER_LEVEL === 'info') {
						// eslint-disable-next-line no-console
						console.info('request cached by throttle adapter: ' + index);
					}

					return responsePromise;
				}
			}

			return recordCacheWithRequest(index, config);
		}

		return adapter(config);
	};
}